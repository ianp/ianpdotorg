
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Digital Magpie</title>
  <meta name="author" content="Ian Phillips">

  
  <meta name="description" content="1066, over at Channel 4 (courtesy of Wonderland). I’ve
often though that there’s a lot of untapped potential in historical
games, and maybe smaller &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ianp.org/page/6">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Digital Magpie" type="application/atom+xml">
  <!--Fonts from Google's Web font directory at http://google.com/webfonts -->
<link href='http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic' rel='stylesheet' type='text/css'>


<script type="text/javascript">
  var _gauges = _gauges || [];
  (function() {
    var t   = document.createElement('script');
    t.type  = 'text/javascript';
    t.async = true;
    t.id    = 'gauges-tracker';
    t.setAttribute('data-site-id', '4fa7e376613f5d2014000195');
    t.src = '//secure.gaug.es/track.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(t, s);
  })();
</script>




  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Digital Magpie</a></h1>
  
    <h2>Ooh, ooh, look - shiny things!</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ianp.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul role=main-navigation>
  <li><a href="/">Blog</a></li>
  <li><a href="/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/05/25/neat-historical-game">Neat Historical Game</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-05-25T17:48:55+02:00" pubdate data-updated="true">May 25<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.channel4.com/history/microsites/0-9/1066/game/index.html">1066</a>, over at <a href="http://www.channel4.com/">Channel 4</a> (courtesy of <a href="http://www.wonderlandblog.com/wonderland/2009/05/1066-the-game.html">Wonderland</a>). I’ve
often though that there’s a lot of untapped potential in historical
games, and maybe smaller efforts like this one are a better way of
leveraging the wealth of material that’s available than, say, more
traditional ‘epic’ style games like Age of Empires.</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/05/25/play-with-your-peas-1">Play With Your Peas 1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-05-25T00:32:05+02:00" pubdate data-updated="true">May 25<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>So the project I’m using to learn Flash and <a href="http://pushbuttonengine.com/">PushButtonEngine</a>
learning is <a href="http://lostgarden.com/">Dan Cook</a>’s <a href="http://lostgarden.com/2008/02/play-with-your-peas-game-prototyping.html">Play with your Peas</a> game prototype
challenge, I’ll keep a log of my progress here. First things are to get
the libraries set up, this was pretty well covered in the last couple of
posts, but the actual steps I took (in brief) are:</p>

<ol>
  <li>checked out PBE from subversion, it’s hosted at <code>http://code.google.com/p/pushbuttonengine/</code> and there are instructions there on how to get it;</li>
  <li>copied the 5 main projects from <code>pushbuttonengine/Projects/Engine</code> into my workspace;</li>
  <li>added <code>build.xml</code> and <code>build.properties</code> files, and set up the dependencies in them;</li>
  <li>created a new project called <code>PlayWithYourPeas</code> and set up the dependencies and build files; and finally</li>
  <li>set up a <code>pbeproj</code> file by copying an existing file and modifying it.</li>
</ol>

<p>At this stage I’m almost ready to start cranking out some
code! But first, I need to copy all of the artwork that I’m going to
use, so I grabbed the zip file from <a href="http://lostgarden.com/2008/02/play-with-your-peas-game-prototyping.html">danc’s site</a> and opened it up,
then created an <code>Assets/Images</code> folder and moved all of the images
apart from the mock-up to there. I also created <code>Levels</code> and
<code>Sounds</code> folders in my <code>Assets</code> folder, as I’ll need them later on.</p>

<p>Now I can finally start writing code. For this project I’m going to
stick to plain ActionScript3 files: no Flex or MXML as I’d like to keep
the gradient of my learning curve down to a reasonable angle! Looking
over the <a href="http://pushbuttonengine.com/docs/">documentation</a> and sample projects I can see that there
are four main files that I need to create for my game: components,
levels, resources, and the main file which, in my case, is going to be
<code>PlayWithYourPeas.as</code>. I can start be just creating each file (<code>⌘N →
AS Class...</code> if you’re using FDT, or however you normally create a new
ActionScript 3 class in your own set-up). I’ll go through each file in
turn and explain what it’s for and what I’ve put in it.</p>

<h3 id="levels">Levels</h3>

<p>The first class I’ll look at is called <code>Levels</code>, in the <code>Levels.as</code>
file. Go ahead and create it now if your following along and haven’t
already done so. The level information in PBE is all loaded from an XML
based level description file, but there needs to be something to hook
that into the rest of the game, and that’s what this class is for. It
just has a single class with a constructor and the following code</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="actionscript"><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nx">Levels</span> <span class="p">{</span>
</span><span class="line">   <span class="kd">public</span> <span class="kd">function</span> <span class="nx">Levels</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">      <span class="nx">LevelManager</span><span class="p">.</span><span class="nx">Instance</span><span class="p">.</span><span class="nx">AddLevelFileReference</span><span class="p">(</span>
</span><span class="line">         <span class="s2">&quot;../Assets/Levels/level-01.pbelevel&quot;</span><span class="o">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class="line">      <span class="nx">LevelManager</span><span class="p">.</span><span class="nx">Instance</span><span class="p">.</span><span class="nx">AddGroupReference</span><span class="p">(</span><span class="s2">&quot;Everything&quot;</span><span class="o">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class="line">      <span class="nx">LevelManager</span><span class="p">.</span><span class="nx">Instance</span><span class="p">.</span><span class="nx">Start</span><span class="p">();</span>
</span><span class="line">   <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The first line tells PBE where to find my level file (I’ll describe it’s
contents later on); the next line tells PBE whereabouts in the file to
start loading things from, and the last line starts the loading process.
The second line is important because you can have a huge amount of stuff
in your levels file and not everything needs to be loaded at the same
time, a single file can contain multiple game levels, allowing them to
share resources. Game levels are simple numbers as far as the engine is
concerned, so you add everything to your level description file and then
set up a group (see below) that contains just the relevant bits and
pieces needed for each actual game level. The second line says that
‘level 0 uses all the things described in the group named “Everything”’.</p>

<p>One last thing to note about this file: the name <code>level-01</code> that I’ve
chosen for my level description file is a bit different from the
examples that are bundles with PBE; this is because I want to be able to
keep the initial download size for my game as small as possible and so
will want to break things up into different levels that can be loaded
asynchronously in the background - this way the player will get a fast
start-up and quick loading of new levels. This game will be too small
for this to matter, but I’d like to try to start off with good habits
then I don’t need to change them later on!</p>

<h3 id="resources">Resources</h3>

<p>This is just
a list of all of the resources (images, sounds, the level description,
and so on) that will be included in the game initially; i.e. will be
packaged up into the SWF or Air installer. As an aside, I’m going to
optimise this for the SWF version of the game, I’ll handle bundling up
additional resources into the Air installer via the build scripts;
although, as with the levels file, for a game this small it makes no
difference.</p>

<p>Initially I’m going to set up my resources so that they
include the level description file (it needs to be references here as
well) and the background image.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="actionscript"><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nx">Resources</span> <span class="p">{</span>
</span><span class="line">   <span class="p">[</span><span class="nx">Embed</span><span class="p">(</span><span class="nx">source</span><span class="o">=</span><span class="s2">&quot;../Assets/Levels/level-01.pbelevel&quot;</span><span class="o">,</span>
</span><span class="line">          <span class="nx">mimeType</span><span class="o">=</span><span class="s1">&#39;application/octet-stream&#39;</span><span class="p">)]</span>
</span><span class="line">   <span class="kd">private</span> <span class="k">var</span> <span class="nx">_level</span><span class="o">:</span><span class="nb">Class</span><span class="o">;</span>
</span><span class="line">   <span class="p">[</span><span class="nx">Embed</span><span class="p">(</span><span class="nx">source</span><span class="o">=</span><span class="s2">&quot;../Assets/Images/Background.png&quot;</span><span class="o">,</span>
</span><span class="line">          <span class="nx">mimeType</span><span class="o">=</span><span class="s1">&#39;application/octet-stream&#39;</span><span class="p">)]</span>
</span><span class="line">   <span class="kd">private</span> <span class="k">var</span> <span class="nx">_background</span><span class="o">:</span><span class="nb">Class</span><span class="o">;</span>
</span><span class="line">   <span class="kd">public</span> <span class="kd">function</span> <span class="nx">Resources</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">      <span class="nx">ResourceManager</span><span class="p">.</span><span class="nx">Instance</span><span class="p">.</span><span class="nx">RegisterEmbeddedResource</span><span class="p">(</span>
</span><span class="line">         <span class="s2">&quot;../Assets/Levels/level-01.pbelevel&quot;</span><span class="o">,</span>
</span><span class="line">         <span class="nx">XMLResource</span><span class="o">,</span>
</span><span class="line">         <span class="k">new</span> <span class="nx">_level</span><span class="p">()</span> <span class="nx">as</span> <span class="nb">ByteArray</span><span class="p">);</span>
</span><span class="line">      <span class="nx">ResourceManager</span><span class="p">.</span><span class="nx">Instance</span><span class="p">.</span><span class="nx">RegisterEmbeddedResource</span><span class="p">(</span>
</span><span class="line">         <span class="s2">&quot;../Assets/Images/Background.png&quot;</span><span class="o">,</span>
</span><span class="line">         <span class="nx">ImageResource</span><span class="o">,</span>
</span><span class="line">         <span class="k">new</span> <span class="nx">_background</span><span class="p">()</span> <span class="nx">as</span> <span class="nb">ByteArray</span><span class="p">);</span>
</span><span class="line">   <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The two private variables here basically hooks to hang the <code>Embed</code>
metadata from. Note that they both need to be octet streams, if you try
to use something more intuitive (say <code>application/xml</code> for the level
description and <code>image/png</code> for the background) it won’t work, as the
PBE class that loads them basically just deals with things in terms of
raw byte arrays. </p>

<p>he code in the constructor tells PBE how to handle the
data in the octet steams: <code>XMLResource</code> and <code>ImageResource</code> are
class names, the <code>_level</code> class is created by the engine based on the
metadata that you pass in, so the <code>new _level()</code> is just using the
<code>Class</code> as an object factory here. Since all of the use of these is
internal to the engine (we just tell it what to do, no actual code
required) this isn’t a problem. Even so, hopefully in a future (i.e.
post 1.0) version of the engine it’ll be possible to use smarter mime
types and have the resource loaders do some automatic conversion as a
result; it’s be nice to be able to declare something of type
<code>application/vnd.mycoolxsd+xml</code> and have it accessible as an
ActionScript XML instance (via the E4X support in AS3).</p>

<h3 id="and-theres-more">And There’s More…</h3>

<p>OK, this has run on for a wile now so I’m going to
finish this up in another post tomorrow, but to whet your appetite
here’s a screenshot of what I’ve got so far:</p>

<p><img src="/images/2009/05/peas-01-bg-and-timer.png" /></p>

<p>Cool, huh? Well,
everybody’s got to start somewhere, but it does demonstrate an import
feature: the timer in the top right hand corner is a custom component
that I’ve written and then added via the level description file, this is
neat as it’s a standard component that I’ll be able to reuse in other
games. I’ll cover the other two files (components and the main game
file) as well as the custom component in my next post in this series…</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/05/24/setting-up-a-flash-development-environment">Setting Up a Flash Development Environment</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-05-24T22:04:57+02:00" pubdate data-updated="true">May 24<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I’ve been playing around with <a href="http://pushbuttonengine.com/">PushButtonEngine</a> and Flash over the
last couple of days, and though it may be useful to document how I’ve
hooked this up to my existing Eclipse install. I’ve started off with a
fairly vanilla Eclipse Java installation, v3.4.2, with the subversion
plug-ins and Oxygen XML for eclipse. The 2 options that I’ve looked at
for Flash development are</p>

<ul>
  <li>
    <p><a href="http://www.axdt.org/">AXDT</a> - an open source plug-in; and</p>
  </li>
  <li>
    <p><a href="http://fdt.powerflasher.com/">FDT</a> - a commercial offering from a company in Germany.</p>
  </li>
</ul>

<p>I’m going
with FDT at the moment as it seems much more feature complete, it comes
with a 30-day trial period so I guess I’ll have to decide if it’s worth
the money after that, the biggest problems it has are a lack of
documentation and poor support from the parent company, on the upside
there seems to be a vibrant and helpful community of users. It’s also
<em>massively</em> overpriced, but that seems to be par for the course with
small German software vendors (EJ Technologies, I’m looking at you…).</p>

<p>I’m using the the build files described <a href="http://ianp.org/2009/05/ant-build-files-for-pushbuttonengine">in a previous post</a>, and
have set up <a href="http://ianp.org/2009/05/level-dtd-for-pushbuttonengine">a custom schema</a> for editing PBE level files. The other
neat tool that I’ve found is the <a href="http://www.monsterdebugger.com/">Monster Debugger</a>, which has a
nice logging UI and the ability to inspect objects at run-time, it can
also dynamically invoke methods, to a fairly limited extent (Flash IDE’s
are about 30 years behind Lisp in this respect, even the JVM can do
limited hot code replacement).</p>

<p>I should probably do a round up of useful
links as well, as the Flash community in general seems to be really
helpful and there’s loads of good stuff out there.</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/05/23/level-definition-dtd-for-pushbuttonengine">Level Definition DTD for PushButtonEngine</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-05-23T04:19:42+02:00" pubdate data-updated="true">May 23<span>rd</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I use Oxygen for all my XML editing and if you have a DTD or schema it has some pretty neat autocompletion and error highlighting features, with that in mind I’ve created a basic DTD for the level definition file in <a href="http://pushbuttonengine.com/">PBE</a>, you can grab it from <a href="/code/2009/05/pbelevel.dtd">here</a>. Note that it’s not ideal, as you get spurious warnings for the fields that you specify inside your component definitions, but there’s not much that can be done about that.</p>

<p><strong>Update:</strong> added an XSD <a href="/code/2009/05/pbelevel.xsd">version of the file</a>, this handles unparsed content gracefully, useful for components.</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/05/22/ant-build-files-for-pushbuttonengine">Ant Build Files for PushButtonEngine</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-05-22T22:40:50+02:00" pubdate data-updated="true">May 22<span>nd</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I’ve started to work up some standard build files for <a href="http://pushbuttonengine.com/">PBE</a> based
projects, more information can be had <a href="http://pushbuttonengine.com/forum/viewtopic.php?f=5&amp;t=166">here</a>, and here are the build
files for <a href="http://ianp.org/files/2009/05/pbe-lib-build.xml">libraries (components)</a>, and for <a href="http://ianp.org/files/2009/05/pbe-app-build.xml">applications (both SWF and Air)</a>.</p>

<p><strong>Update:</strong> updated the build files to work better with pure AS3 projects (i.e. with no MXML files).</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/05/15/thats-how-i-felt-too">That&#8217;s How I Felt Too!</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-05-15T13:47:00+02:00" pubdate data-updated="true">May 15<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.raphkoster.com/2009/05/14/the-perfect-geek-age/">And feel like I had inside baseball knowledge during the D&amp;D scene in E.T.</a></p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/04/28/embedding-clojure-part-2">Embedding Clojure (Part 2)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-04-28T08:20:08+02:00" pubdate data-updated="true">Apr 28<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Following on from the last post, it actually turns out to be much easier
to do most of the work in Clojure itself — no need for all of that
tiresome messing around with <code>Var</code>s and <code>Symbols</code>s on the Java side
of things! The trick is to define an abstract class in Java to set a few
things up and use as a hook, than implement this in Clojure. I’ll go
through both sides of this, starting with the Java stuff.</p>

<h3 id="the-abstract-class-in-java">The Abstract Class in Java</h3>

<p>Basically, I’m using the Java side of things to
set up my text pane with a standard stylesheet (I’d like it to use a
proportional font, with different colours for input, output, and error
text) and to install a key listener to send commands to the Clojure repl
whenever the user hits enter or return. The basic class then, is</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">InteractiveConsole</span> <span class="o">{</span>
</span><span class="line">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Document</span> <span class="n">_document</span> <span class="o">=</span> <span class="n">createStyledDocument</span><span class="o">():</span>
</span><span class="line">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">JTextPane</span> <span class="n">_textpane</span><span class="o">;</span>
</span><span class="line">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">PipedWriter</span> <span class="n">_inWriter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PipedWriter</span><span class="o">();</span>
</span><span class="line">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Reader</span> <span class="n">_in</span><span class="o">;</span>
</span><span class="line">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Writer</span> <span class="n">_out</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">DocWriter</span><span class="o">(</span><span class="s">&quot;output&quot;</span><span class="o">),</span> <span class="kc">true</span><span class="o">);</span>
</span><span class="line">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Writer</span> <span class="n">_err</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PrintWriter</span><span class="o">(</span><span class="k">new</span> <span class="n">DocWriter</span><span class="o">(</span><span class="s">&quot;error&quot;</span><span class="o">),</span> <span class="kc">true</span><span class="o">);</span>
</span><span class="line">    <span class="kd">protected</span> <span class="nf">InteractiveConsole</span><span class="o">(</span><span class="n">JTextPane</span> <span class="n">textpane</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span class="line">        <span class="n">_textpane</span> <span class="o">=</span> <span class="n">textpane</span><span class="o">;</span>
</span><span class="line">        <span class="n">_in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PipedReader</span><span class="o">(</span><span class="n">_inWriter</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>createStyledDocument</code> method, which I won’t include here, just
sets up the style context and my colour scheme. The <code>DocWriter</code> class
that is references is an trivial writer subclass that just calls
<code>insertString</code> on the document with the named style. The other class
that I’ll be wanting to use is a runnable so that I can launch the
Clojure REPL on it’s own thread. It’s about as trivial as it gets, it
just calls back into the two abstract methods that I’m going to provide
to provide my Clojure code somewhere to hook onto.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">private</span> <span class="kd">class</span> <span class="nc">ConsoleRunner</span> <span class="kd">implements</span> <span class="n">Runnable</span> <span class="o">{</span>
</span><span class="line">    <span class="kd">private</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">_context</span><span class="o">;</span>
</span><span class="line">    <span class="kd">public</span> <span class="nf">ConsoleRunner</span><span class="o">(</span><span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
</span><span class="line">      <span class="n">_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">;</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line">    <span class="nd">@Override</span>
</span><span class="line">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
</span><span class="line">        <span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">var</span> <span class="o">:</span> <span class="n">_context</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
</span><span class="line">            <span class="n">bindVariable</span><span class="o">(</span><span class="n">var</span><span class="o">.</span><span class="na">getKey</span><span class="o">(),</span> <span class="n">var</span><span class="o">.</span><span class="na">getValue</span><span class="o">());</span>
</span><span class="line">        <span class="o">}</span>
</span><span class="line">        <span class="n">doStart</span><span class="o">(</span><span class="n">_in</span><span class="o">,</span> <span class="n">_out</span><span class="o">,</span> <span class="n">_err</span><span class="o">);</span>
</span><span class="line">    <span class="o">}</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With this I can provide a start method that installs my key listener and
then launches a new thread with an instance of this runnable. The two
hook methods that I’m providing are:</p>

<ul>
  <li>
    <p><code>abstract void bindVariable(String,Object)</code>
to allow me to set up some domain objects on the clojure side of things; and</p>
  </li>
  <li>
    <p><code>abstract void doStart(Reader,Writer,Writer)</code>
to actually start the REPL, using the provided input, output, and error streams.</p>
  </li>
</ul>

<h3 id="the-clojure-implementation">The Clojure Implementation</h3>

<p>Turns out to be trivial as well, the implementation of <code>bindVariable</code> just interns the object passed in into the user
namespace, it’s a one liner in Clojure.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="clj"><span class="line"><span class="p">(</span><span class="nf">defn</span><span class="w"> </span><span class="nv">-bindVariable</span><span class="w"> </span><span class="p">[</span><span class="nv">this</span><span class="w"> </span><span class="nv">name</span><span class="w"> </span><span class="nv">value</span><span class="p">]</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="p">(</span><span class="nf">intern</span><span class="w"> </span><span class="ss">&#39;user</span><span class="w"> </span><span class="p">(</span><span class="nf">symbol</span><span class="w"> </span><span class="nv">name</span><span class="p">)</span><span class="w"> </span><span class="nv">value</span><span class="p">))</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>doStart</code> method isn’t much more involved either, it just sets up
the bindings and then launches the REPL.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="clj"><span class="line"><span class="p">(</span><span class="nf">defn</span><span class="w"> </span><span class="nv">-doStart</span><span class="w"> </span><span class="p">[</span><span class="nv">this</span><span class="w"> </span><span class="o">#^</span><span class="nv">Reader</span><span class="w"> </span><span class="nv">in</span><span class="w"> </span><span class="o">#^</span><span class="nv">Writer</span><span class="w"> </span><span class="nv">out</span><span class="w"> </span><span class="o">#^</span><span class="nv">Writer</span><span class="w"> </span><span class="nv">err</span><span class="p">]</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="p">(</span><span class="nf">binding</span><span class="w"> </span><span class="p">[</span><span class="nv">*in*</span><span class="w">  </span><span class="p">(</span><span class="nf">LineNumberingPushbackReader.</span><span class="w"> </span><span class="nv">in</span><span class="p">)</span><span class="w"></span>
</span><span class="line"><span class="w">              </span><span class="nv">*out*</span><span class="w"> </span><span class="nv">out</span><span class="w"></span>
</span><span class="line"><span class="w">              </span><span class="nv">*err*</span><span class="w"> </span><span class="nv">err</span><span class="p">]</span><span class="w"></span>
</span><span class="line"><span class="w">        </span><span class="p">(</span><span class="nf">clojure.main/repl</span><span class="p">)))</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Notice that here I have added type annotations so that the correct
method gets implemented, without these the Clojure code compiled but
then I got abstract method errors at runtime. Check out the docstring
for the <code>repl</code> function as well, there are a few useful options (for
example in my actual code I have an <code>:init</code> function to switch to the
user namespace, and a custom prompt). For completeness, here’s the rest
of the Clojure file with the code required to inherit from the Java base
class.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="clj"><span class="line"><span class="p">(</span><span class="nf">ns</span><span class="w"> </span><span class="nv">com.example.ClojureConsole</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="p">(</span><span class="no">:import</span><span class="w"> </span><span class="p">(</span><span class="nf">clojure.lang</span><span class="w"> </span><span class="nv">LineNumberingPushbackReader</span><span class="p">)</span><span class="w"></span>
</span><span class="line"><span class="w">             </span><span class="p">(</span><span class="nf">java.io</span><span class="w"> </span><span class="nv">Reader</span><span class="w"> </span><span class="nv">Writer</span><span class="p">)</span><span class="w"></span>
</span><span class="line"><span class="w">             </span><span class="p">(</span><span class="nf">java.util</span><span class="w"> </span><span class="nv">Map</span><span class="p">))</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="p">(</span><span class="no">:require</span><span class="w"> </span><span class="p">(</span><span class="nf">clojure</span><span class="w"> </span><span class="nv">main</span><span class="p">))</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="p">(</span><span class="no">:gen-class</span><span class="w"></span>
</span><span class="line"><span class="w">     </span><span class="no">:extends</span><span class="w"> </span><span class="nv">bg.beer.editor.InteractiveConsole</span><span class="w"></span>
</span><span class="line"><span class="w">     </span><span class="no">:init</span><span class="w"> </span><span class="nv">init</span><span class="w"></span>
</span><span class="line"><span class="w">     </span><span class="no">:constructors</span><span class="w"> </span><span class="p">{[</span><span class="nv">javax.swing.JTextPane</span><span class="p">]</span><span class="w"> </span><span class="p">[</span><span class="nv">String</span><span class="w"> </span><span class="nv">javax.swing.JTextPane</span><span class="p">]}))</span><span class="w"></span>
</span><span class="line"><span class="p">(</span><span class="nf">defn</span><span class="w"> </span><span class="nv">-init</span><span class="w"> </span><span class="p">[</span><span class="nv">textpane</span><span class="p">]</span><span class="w"></span>
</span><span class="line"><span class="w">    </span><span class="p">[[</span><span class="nv">textpane</span><span class="p">]])</span><span class="w"></span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="summary">Summary</h3>

<p>This approach has the advantage that any additional
configuration can happen in the clojure code. It would also be easy, for
example, to have an additional script that was always run at start up,
to allow the user to customize the console further (similar to the
.emacs file in Emacs). You could also move most of the work that I’m
doing in Java into the Clojure code. I haven’t done this as I may want
to support multiple languages in my console and it’s nice to have a
common stylesheet and keybindings (e.g. for history) across languages.
Your mileage may vary.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/04/27/embedding-clojure-in-an-existing-application">Embedding Clojure in an Existing Application</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-04-27T10:57:37+02:00" pubdate data-updated="true">Apr 27<span>th</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I’ve been taking a look at <a href="http://www.clojure.org/">Clojure</a> lately, as a JVM friendly
flavour of Lisp I’ve got to say it looks pretty interesting. One problem
that I’ve had though is that all of the documentation out there (of
which there’s very little, to be honest) seems to assume that you’ll be
writing/running a pure Clojure program as you main application. There’s
plenty of information about calling Java code from Clojure programs, and
<em>some</em> information about extending Java classes and interfaces with
Clojure code, but nothing about getting the two talking together at
runtime. So here’s how it’s done.</p>

<p>First off you need to set up the
symbols and namespaces that you are going to need to start up a clojure
environment.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">Symbol</span> <span class="n">main</span> <span class="o">=</span> <span class="n">Symbol</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">&quot;main&quot;</span><span class="o">);</span>
</span><span class="line"><span class="n">Symbol</span> <span class="n">clojureMain</span> <span class="o">=</span> <span class="n">Symbol</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">&quot;clojure.main&quot;</span><span class="o">);</span>
</span><span class="line"><span class="n">Symbol</span> <span class="n">user</span> <span class="o">=</span> <span class="n">Symbol</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">);</span>
</span><span class="line"><span class="n">Symbol</span> <span class="n">require</span> <span class="o">=</span> <span class="n">Symbol</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="s">&quot;require&quot;</span><span class="o">);</span>
</span><span class="line"><span class="n">Namespace</span> <span class="n">userNS</span> <span class="o">=</span> <span class="n">Namespace</span><span class="o">.</span><span class="na">findOrCreate</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
</span><span class="line"><span class="n">Namespace</span> <span class="n">clojureMainNS</span> <span class="o">=</span> <span class="n">Namespace</span><span class="o">.</span><span class="na">findOrCreate</span><span class="o">(</span><span class="n">clojureMain</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Once you have these you can <em>require</em> the clojure main namespace, this
is the same one that is used to run scripts or start a REPL from the
comand line.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">Var</span><span class="o">.</span><span class="na">intern</span><span class="o">(</span><span class="n">RT</span><span class="o">.</span><span class="na">CLOJURE_NS</span><span class="o">,</span> <span class="n">require</span><span class="o">).</span><span class="na">invoke</span><span class="o">(</span><span class="n">clojureMain</span><span class="o">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then, and this is the bit that I had trouble working out, you need to
bind your application’s domain model (or at least those bits of it that
you want to expose) into the <em>user</em> namespace in Clojure.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="k">for</span> <span class="o">(</span><span class="n">Map</span><span class="o">.</span><span class="na">Entry</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Object</span><span class="o">&gt;</span> <span class="n">global</span> <span class="o">:</span> <span class="n">globals</span><span class="o">.</span><span class="na">entrySet</span><span class="o">())</span> <span class="o">{</span>
</span><span class="line">    <span class="n">String</span> <span class="n">key</span> <span class="o">=</span> <span class="n">global</span><span class="o">.</span><span class="na">getKey</span><span class="o">();</span>
</span><span class="line">    <span class="n">Object</span> <span class="n">value</span> <span class="o">=</span> <span class="n">global</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
</span><span class="line">    <span class="n">Var</span><span class="o">.</span><span class="na">intern</span><span class="o">(</span><span class="n">userNS</span><span class="o">,</span> <span class="n">Symbol</span><span class="o">.</span><span class="na">create</span><span class="o">(</span><span class="n">key</span><span class="o">),</span> <span class="n">value</span><span class="o">);</span>
</span><span class="line"><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Finally you’re ready to grab the <code>main</code> method and run it.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">Var</span><span class="o">.</span><span class="na">intern</span><span class="o">(</span><span class="n">clojureMainNS</span><span class="o">,</span> <span class="n">main</span><span class="o">).</span><span class="na">applyTo</span><span class="o">(</span><span class="n">RT</span><span class="o">.</span><span class="na">seq</span><span class="o">(</span><span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="mi">0</span><span class="o">]));</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The emtpy string array here is emulating an emty sargument list at the
command line. Some things to note here: you need to <em>intern</em> vars
before you can use them, even for core library features like
<em>require</em>, this surprised me at first but when you remember that most
Lisps are built around a very small core of special forms with
everything else defined in Lisp, it makes some sense.</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/04/23/guice-development-stages">Guice Development Stages</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-04-23T17:51:24+02:00" pubdate data-updated="true">Apr 23<span>rd</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://google-guice.googlecode.com/">Guice</a> has a concept called <em>develpment stages</em> which affect how
the library works. Guice is written with server-side applications in
mind (it is from Google, after all) so the behaviour for production mode
is to do a bunch of work up front so that it can catch errors as soon as
possible.</p>

<p>The development mode defers work (i.e. object creation) until
the last moment; Here’s how the Javadoc notes describe them:</p>

<ul>
  <li>
    <p><strong>Development</strong>
we want fast startup times at the expense of runtime performance and some up front error checking.</p>
  </li>
  <li>
    <p><strong>Production</strong>
we want to catch errors as early as possible and take performance hits up front.</p>
  </li>
  <li>
    <p><strong>Tool</strong>
we’re running in a tool (an IDE plugin for example).</p>
  </li>
</ul>

<p>Ignoring tool mode, this is exactly the opposite of the behaviour that
you want to see for client-side development. For client applications you
want to have an much error checking as possible during development but
for production use (i.e. use by a real user) you want to go for faster
start-up times.</p>

<p>Note that for production use it is also advantageous to
defer error checking until later as well; after all, there is no point
in refusing to start an app because feature ‘foo’ isn’t working, if the
user doesn’t use or care about ‘foo’!</p>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/2009/04/21/understanding-event-propagation-in-ardor3d">Understanding Event Propagation in Ardor3D</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2009-04-21T14:07:50+02:00" pubdate data-updated="true">Apr 21<span>st</span>, 2009</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.ardor3d.com/">Ardor3D</a> adds a mechanism for subscribing to events in the scene
graph; things like when a node is added or removed, or has one of it’s
render states or it’s bounding volume altered. The way notifications are
handled is a little confusing at first, as the listener interface
(<code>DirtyEventListener</code>) has a method which takes a <code>Spatial</code> as it’s
first argument; hoever, the spatial is the node in the scene graph on
which the event occurred, it is <em>not</em> the node that the event is fired
from.</p>

<p>By way of example: if there are 2 scene nodes, a <code>Spatial</code> named
‘child’ and a <code>Node</code> named ‘parent’, and the child is attached to the
parent via a call to <code>Node#attachChild(Spatial)</code> then the following
events will be fired (assuming that the child was not already attached
to another node):</p>

<ol>
  <li>from the child: <code>spatialDirty(child, Attached)</code></li>
  <li>
    <p>from the parent: <code>spatialDirty(child, Attached)</code>
if the parent was attached to another node (for example, ‘grandparent’) then this pattern would continue, like so:</p>
  </li>
  <li>from the grandparent: spatialDirty(child, Attached) also, if at any point in this one of the <code>spatialDirty</code> calls returns true, then the event is assumed to have been handled and propagation will stop at that point.</li>
</ol>

<p>What this means in practice is that
if you need to know which node an event is being fired from you cannot
reuse listeners on multiple nodes. For detaching nodes the situation is
a little different: the event propagation starts at the parent node,
with the detached child passed as as the method argument.</p>

<p>Be aware that
the parent will already have been set to <code>null</code> when the event is
fired though, so if you need to be able to do something with the parent
you will need to add distinct listeners to each node of interest.</p>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/page/7/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/page/5/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2012/11/05/stroke-me-gently">Stroke Me Gently</a>
      </li>
    
      <li class="post">
        <a href="/2012/10/31/rearranging-the-apples">Rearranging the Apples</a>
      </li>
    
      <li class="post">
        <a href="/2012/10/30/vlc-versions">VLC Versions</a>
      </li>
    
      <li class="post">
        <a href="/2012/10/30/category-counts-in-octopress-revisited">Category Counts in OctoPress Revisited</a>
      </li>
    
      <li class="post">
        <a href="/2012/10/03/netbeans-rich-client-platform">NetBeans Rich Client Platform</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/ianp">@ianp</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'ianp',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2003&ndash;2012 &mdash; Ian Phillips &mdash;
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>, <a href="http://github.com/">GitHub</a>, and too much coffee.</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'ianpdotorg';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
